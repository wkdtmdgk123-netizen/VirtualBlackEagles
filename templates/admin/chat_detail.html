<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… - {{ session['user_name'] }} - ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="/static/style.css?v=917">
    <style>
        body {
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .admin-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>

<div class="admin-content">
    <div class="page-header">
        <div>
            <a href="{{ url_for('admin_chats') }}" class="back-btn">â† ì±„íŒ… ëª©ë¡ìœ¼ë¡œ</a>
            <h1>ğŸ’¬ {{ session['user_name'] or 'ìµëª…' }}ë‹˜ê³¼ì˜ ëŒ€í™”</h1>
            <p>ì„¸ì…˜ ID: {{ session['session_id'] }}</p>
        </div>
        <div>
            {% if session['status'] == 'active' %}
            <button onclick="closeSession()" class="btn btn-danger">ëŒ€í™” ì¢…ë£Œ</button>
            {% else %}
            <span class="status-badge closed">ì¢…ë£Œëœ ëŒ€í™”</span>
            {% endif %}
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="chat-message {{ message['sender_type'] }}">
                <div class="message-header">
                    <span class="sender-name">
                        {% if message['sender_type'] == 'user' %}
                            ğŸ‘¤ {{ message['sender_name'] }}
                        {% else %}
                            ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì
                        {% endif %}
                    </span>
                    <span class="message-time">{{ message['created_at'] }}</span>
                </div>
                <div class="message-content">{{ message['message'] }}</div>
            </div>
            {% endfor %}
        </div>

        {% if session['status'] == 'active' %}
        <div class="chat-input-container">
            <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
            <button onclick="sendMessage()" class="btn btn-primary">ì „ì†¡</button>
        </div>
        {% endif %}
    </div>
</div>

<script>
const sessionId = '{{ session['session_id'] }}';
const isActive = {{ 'true' if session['status'] == 'active' else 'false' }};

// ë©”ì‹œì§€ ì „ì†¡
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) {
        alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch('/api/admin/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: sessionId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages();
        } else {
            alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë©”ì‹œì§€ ë¡œë“œ
function loadMessages() {
    fetch(`/api/chat/messages/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMessages(data.messages);
            }
        })
        .catch(error => console.error('Error loading messages:', error));
}

// ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
function updateMessages(messages) {
    const container = document.getElementById('chatMessages');
    const currentScroll = container.scrollTop;
    const isScrolledToBottom = container.scrollHeight - container.scrollTop === container.clientHeight;
    
    container.innerHTML = messages.map(msg => `
        <div class="chat-message ${msg.sender_type}">
            <div class="message-header">
                <span class="sender-name">
                    ${msg.sender_type === 'user' ? 'ğŸ‘¤ ' + msg.sender_name : 'ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì'}
                </span>
                <span class="message-time">${msg.created_at}</span>
            </div>
            <div class="message-content">${escapeHtml(msg.message)}</div>
        </div>
    `).join('');
    
    if (isScrolledToBottom) {
        container.scrollTop = container.scrollHeight;
    }
}

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ì„¸ì…˜ ì¢…ë£Œ
function closeSession() {
    if (!confirm('ì •ë§ë¡œ ì´ ëŒ€í™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/admin/chats/${sessionId}/close`, {
        method: 'POST'
    })
    .then(() => {
        window.location.href = '{{ url_for('admin_chats') }}';
    });
}

// Enter í‚¤ë¡œ ì „ì†¡
document.getElementById('messageInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// 3ì´ˆë§ˆë‹¤ ìƒˆ ë©”ì‹œì§€ í™•ì¸ (í™œì„± ì„¸ì…˜ì¸ ê²½ìš°)
if (isActive) {
    setInterval(loadMessages, 3000);
}

// ì´ˆê¸° ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
</script>

<style>
.back-btn {
    display: inline-block;
    color: #007bff;
    text-decoration: none;
    margin-bottom: 10px;
    font-size: 14px;
}

.back-btn:hover {
    text-decoration: underline;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.status-badge {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

.status-badge.closed {
    background: #f5f5f5;
    color: #757575;
}

.chat-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    height: calc(100vh - 250px);
    min-height: 500px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.chat-message {
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
}

.chat-message.user {
    align-items: flex-start;
}

.chat-message.admin {
    align-items: flex-end;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.sender-name {
    font-size: 12px;
    font-weight: 600;
    color: #666;
}

.message-time {
    font-size: 11px;
    color: #999;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.chat-message.user .message-content {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
}

.chat-message.admin .message-content {
    background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
    color: #333;
    border-bottom-right-radius: 4px;
}

.chat-input-container {
    padding: 16px;
    background: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 12px;
}

.chat-input-container textarea {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    resize: none;
    font-family: inherit;
}

.chat-input-container textarea:focus {
    outline: none;
    border-color: #ffd700;
}

.chat-input-container button {
    padding: 10px 24px;
    white-space: nowrap;
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
</body>
</html>
